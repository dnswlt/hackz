<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gamez!</title>
    <script type="text/javascript">
        function gameId() {
            let pathSegs = window.location.pathname.split("/");
            return pathSegs[pathSegs.length - 1];
        }

        async function postSomething() {
            console.log("postSomething");
            return fetch("/hexz/move/" + gameId(), {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    row: 1,
                    col: 1
                }),
            })
            // let resp = await response.json();
            // console.log(resp);
        }
    </script>
</head>

<body>
    <div>
        <canvas id="canvas" width="700" height="600"></canvas>
    </div>
    <div id="controls">
        <button id="reset">Reset</button>
        <button id="postSth" onclick="postSomething()">Post Sth</button>
    </div>

    <script type="text/javascript">
        function hexagon(a) {
            let p = new Path2D();
            let b2 = Math.sqrt(3) * a / 2;
            let a2 = a / 2
            p.moveTo(b2, a2);
            p.lineTo(0, a);
            p.lineTo(-b2, a2);
            p.lineTo(-b2, -a2);
            p.lineTo(0, -a);
            p.lineTo(b2, -a2);
            p.lineTo(b2, a2);
            return {
                path: p,
                sideLength: a,
                value: 0,
                x: 0,
                y: 0,
            };
        }

        function drawBbox(ctx) {
            let b = Math.sqrt(3) * hexagonSideLength;
            let width = numFieldsHorizontally * b + 2 * pad;
            let a2 = 2 * Math.floor((numFieldsVertically + 1) / 2);
            let a = Math.floor(numFieldsVertically / 2);
            let height = (a + a2) * hexagonSideLength + 2 * pad;
            ctx.rect(0, 0, width, height);
            ctx.strokeStyle = "#000000";
            ctx.stroke();
        }

        function drawHexagons(ctx) {
            for (const fld of gstate.fields) {
                ctx.translate(fld.x, fld.y);
                if (fld.value != 0) {
                    let p = fld.value > 0 ? 0 : 1;
                    ctx.fillStyle = styles.colors.players[p];
                    ctx.fill(fld.path);
                }
                ctx.strokeStyle = styles.colors.grid;
                ctx.stroke(fld.path);
                // Undo transform.
                ctx.translate(-fld.x, -fld.y);
            }
        }

        function redraw(ctx) {
            ctx.resetTransform();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawBbox(ctx);
            ctx.translate(pad, pad);
            drawHexagons(ctx);
        }

        function initialize() {
            const c = document.getElementById("canvas");
            const ctx = canvas.getContext("2d");
            let a = hexagonSideLength;
            let b = Math.sqrt(3) * a;
            let nRows = numFieldsVertically;
            for (let i = 0; i < nRows; i++) {
                let nCols = (i % 2 == 0) ? numFieldsHorizontally : numFieldsHorizontally - 1;
                for (let j = 0; j < nCols; j++) {
                    let xOff = (i % 2 == 0) ? 0 : b / 2;
                    let hex = hexagon(a);
                    hex.x = xOff + j * b + b / 2;
                    hex.y = i * a * 3 / 2 + a;
                    gstate.fields.push(hex);
                }
            }
            redraw(ctx);

            canvas.addEventListener('click', function (event) {
                ctx.resetTransform();
                ctx.translate(pad, pad);
                let found = false;
                for (const fld of gstate.fields) {
                    ctx.translate(fld.x, fld.y);
                    if (ctx.isPointInPath(fld.path, event.offsetX, event.offsetY)) {
                        clickedOnField(fld);
                        ctx.translate(-fld.x, -fld.y);
                        break;
                    }
                    ctx.translate(-fld.x, -fld.y);
                }
                redraw(ctx);
            });
            document.getElementById("reset").onclick = reset;

            let pathSegs = window.location.pathname.split("/");
            let gameId = pathSegs[pathSegs.length - 1];
            const evtSource = new EventSource("/hexz/sse/" + gameId);
            evtSource.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                console.log("Server-sent event: ", msg);
            }
            evtSource.onerror = (err) => {
                console.error("EventSource failed:", err);
            }
        }

        function clickedOnField(fld) {
            if (fld.value != 0) {
                return;
            }
            fld.value = gstate.turn;
            gstate.turn = -gstate.turn;
        }

        function reset() {
            const c = document.getElementById("canvas");
            const ctx = canvas.getContext("2d");
            for (let fld of gstate.fields) {
                fld.value = 0;
            }
            gstate.turn = 1;
            gstate.moves = [];
            redraw(ctx);
        }

        const hexagonSideLength = 30;
        const numFieldsHorizontally = 10;
        const numFieldsVertically = 11;
        const pad = 20;

        const styles = {
            colors: {
                grid: '#000000',
                players: ['#255ab4', '#f8d748'],
            },
        };

        var gstate = {
            fields: [],
            moves: [],
            turn: 1,
        };

        initialize();

    </script>
</body>

</html>
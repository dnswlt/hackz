<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gamez!</title>
    <style>
        #canvas {
            border: solid 1px;
        }
    </style>
    <script type="text/javascript">
        function gameId() {
            let pathSegs = window.location.pathname.split("/");
            return pathSegs[pathSegs.length - 1];
        }

        async function sendMove(row, col) {
            return fetch("/hexz/move/" + gameId(), {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    row: row,
                    col: col,
                }),
            })
        }

        const gstate = {
            board: null,
        };

        function handleServerEvent(serverEvent) {
            /*
                type Field struct {
                    Value int `json:"value"`
                    Owner int `json:"owner"` // Player number owning this field.
                }

                type Board struct {
                    Turn   int       `json:"turn"`
                    Fields [][]Field `json:"fields"`
                }

                type ServerEvent struct {
                    Timestamp    string `json:"timestamp"`
                    Board        *Board `json:"board"`
                    DebugMessage string `json:"debugMessage"`
                }
            */
            if (serverEvent.board != null) {
                // new board received.
                gstate.board = serverEvent.board;
                redraw();
            }
            if (serverEvent.debugMessage.length > 0) {
                console.log(serverEvent.timestamp + ": " + serverEvent.debugMessage);
            }
        }
    </script>
</head>

<body>
    <div>
        <canvas id="canvas" width="560" height="550"></canvas>
    </div>
    <div id="controls">
        <button id="reset">Reset</button>
    </div>

    <script type="text/javascript">
        // Returns a Path2D representing a 0-centered hexagon with side length a.
        function hexagon(a) {
            let p = new Path2D();
            let b2 = Math.sqrt(3) * a / 2;
            let a2 = a / 2
            p.moveTo(b2, a2);
            p.lineTo(0, a);
            p.lineTo(-b2, a2);
            p.lineTo(-b2, -a2);
            p.lineTo(0, -a);
            p.lineTo(b2, -a2);
            p.lineTo(b2, a2);
            return p;
        }

        function drawHexagons(ctx) {
            let a = hexagonSideLength;
            let b = Math.sqrt(3) * a;
            let nRows = gstate.board.fields.length;
            let hex = hexagon(a);
            for (let i = 0; i < nRows; i++) {
                for (let j = 0; j < gstate.board.fields[i].length; j++) {
                    let xOff = (i % 2 == 0) ? 0 : b / 2;
                    let x = xOff + j * b + b / 2;
                    let y = i * a * 3 / 2 + a;
                    let fld = gstate.board.fields[i][j];
                    ctx.translate(x, y);
                    if (fld.value != 0) {
                        ctx.fillStyle = styles.colors.players[fld.owner - 1];
                        ctx.fill(hex);
                    }
                    ctx.strokeStyle = styles.colors.grid;
                    ctx.stroke(hex);
                    // Undo transform.
                    ctx.translate(-x, -y);
                }
            }
        }

        function redraw() {
            const c = document.getElementById("canvas");
            const ctx = canvas.getContext("2d");
            ctx.resetTransform();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.translate(pad, pad);
            drawHexagons(ctx);
        }

        function initialize() {

            canvas.addEventListener('click', function (event) {
                const c = document.getElementById("canvas");
                const ctx = canvas.getContext("2d");
                ctx.resetTransform();
                ctx.translate(pad, pad);
                let a = hexagonSideLength;
                let b = Math.sqrt(3) * a;
                let nRows = gstate.board.fields.length;
                let hex = hexagon(a);
                for (let i = 0; i < nRows; i++) {
                    for (let j = 0; j < gstate.board.fields[i].length; j++) {
                        let xOff = (i % 2 == 0) ? 0 : b / 2;
                        let x = xOff + j * b + b / 2;
                        let y = i * a * 3 / 2 + a;
                        ctx.translate(x, y);
                        if (ctx.isPointInPath(hex, event.offsetX, event.offsetY)) {
                            clickedOnField(i, j);
                            break;
                        }
                        ctx.translate(-x, -y);
                    }
                }
                ctx.resetTransform();
            });

            document.getElementById("reset").onclick = reset;

            const evtSource = new EventSource("/hexz/sse/" + gameId());
            evtSource.onmessage = (event) => {
                const serverEvent = JSON.parse(event.data);
                handleServerEvent(serverEvent);
            }
            evtSource.onerror = (err) => {
                // Do nothing for now, the Browser will try to reconnect.
            }
        }

        function clickedOnField(row, col) {
            sendMove(row, col);
        }

        function reset() {
            redraw();
        }

        const hexagonSideLength = 30;
        const numFieldsHorizontally = 10;
        const numFieldsVertically = 11;
        const pad = 20;

        const styles = {
            colors: {
                grid: '#000000',
                players: ['#255ab4', '#f8d748'],
            },
        };

        initialize();

    </script>
</body>

</html>
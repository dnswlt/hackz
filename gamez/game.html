<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Hexz</title>
    <style>
        html,
        body {
            width: 100%;
            height: 100%;
            margin: 0;
            background-color: #1e1e1e;
            color: #cbcbcb;
        }

        body {
            font-family: arial, sans-serif;
        }

        .menu {
            padding-left: 2px;
            padding-right: 2px;
        }

        .menuitem {
            display: inline;
        }
    </style>
    <script type="text/javascript">
        function gameId() {
            let pathSegs = window.location.pathname.split("/");
            return pathSegs[pathSegs.length - 1];
        }

        async function sendMove(row, col) {
            return fetch("/hexz/move/" + gameId(), {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    row: row,
                    col: col,
                }),
            })
        }

        async function resetGame() {
            return fetch("/hexz/reset/" + gameId(), {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    message: "reset",
                }),
            })
        }
        const gstate = {
            board: null,
            role: 0,
        };

        function handleServerEvent(serverEvent) {
            if (serverEvent.role > 0) {
                gstate.role = serverEvent.role;
            }
            if (serverEvent.board != null) {
                // new board received.
                gstate.board = serverEvent.board;
                redraw();
                updateTurnInfo();
                updateScore();
            }
            if (serverEvent.debugMessage.length > 0) {
                console.log(serverEvent.timestamp + ": " + serverEvent.debugMessage + " " + serverEvent.activeGames);
            }
            if (serverEvent.activeGames && serverEvent.activeGames.length > 0) {
                updateActiveGames(serverEvent.activeGames);
            }
        }

        function updateScore() {
            let div = document.getElementById("scoreInfo");
            const s = gstate.board.score;
            div.innerHTML = `${s[0]} &ndash; ${s[1]}`
        }

        function updateTurnInfo() {
            let div = document.getElementById("turnInfo");
            if (gstate.role > 0) {
                // one of the players
                div.innerHTML = (gstate.board.turn == gstate.role) ? "Your turn" : "Opponent's turn";
            } else {
                // spectator
                div.innerHTML = (gstate.board.turn == 1) ? "Blue's turn" : "Yellow's turn";
            }
        }

        function updateActiveGames(gameIds) {
            let div = document.getElementById("activeGames");
            let html = ["Other games: "];
            let ownId = gameId();
            for (gId of gameIds) {
                if (gId != ownId) {
                    html.push(`<a href="/hexz/${gId}">${gId}</a>`);
                }
            }
            if (html.length > 1) {
                div.innerHTML = html.join(" ");
            } else {
                // No other ongoing games.
                div.innerHTML = "";
            }
        }

        function newGame() {
            window.location.replace("/hexz");
        }
    </script>
</head>

<body>
    <div>
        <canvas id="canvas" width="560" height="550"></canvas>
    </div>
    <div id="controls" class="menu">
        <button id="home" class="menuitem" onclick="newGame()">New Game</button>
        <button id="reset" class="menuitem" onclick="resetGame()">Reset</button>
        <div class="menuitem" id="scoreInfo"></div>
        <div class="menuitem" id="turnInfo"></div>
        <div class="menuitem" id="activeGames"></div>
    </div>

    <script type="text/javascript">
        // Returns a Path2D representing a 0-centered hexagon with side length a.
        function hexagon(a) {
            let p = new Path2D();
            let b2 = Math.sqrt(3) * a / 2;
            let a2 = a / 2
            p.moveTo(b2, a2);
            p.lineTo(0, a);
            p.lineTo(-b2, a2);
            p.lineTo(-b2, -a2);
            p.lineTo(0, -a);
            p.lineTo(b2, -a2);
            p.lineTo(b2, a2);
            return p;
        }

        function drawBoard(ctx) {
            if (!gstate.board) {
                return;
            }
            let a = hexagonSideLength;
            let b = Math.sqrt(3) * a;
            let nRows = gstate.board.fields.length;
            let hex = hexagon(a);
            for (let i = 0; i < nRows; i++) {
                for (let j = 0; j < gstate.board.fields[i].length; j++) {
                    let xOff = (i % 2 == 0) ? 0 : b / 2;
                    let x = xOff + j * b + b / 2;
                    let y = i * a * 3 / 2 + a;
                    let fld = gstate.board.fields[i][j];
                    ctx.translate(x, y);
                    if (fld.value != 0) {
                        ctx.fillStyle = styles.colors.players[fld.owner - 1];
                        ctx.fill(hex);
                    }
                    ctx.strokeStyle = styles.colors.grid;
                    ctx.stroke(hex);
                    // Undo transform.
                    ctx.translate(-x, -y);
                }
            }
        }

        function redraw() {
            const c = document.getElementById("canvas");
            const ctx = canvas.getContext("2d");
            ctx.resetTransform();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.translate(pad, pad);
            drawBoard(ctx);
        }

        function resizeCanvas() {
            const canvas = document.getElementById("canvas");
            const defaultWidth = 560;
            const defaultHeight = 550;
            canvas.width = document.body.clientWidth;
            canvas.height = Math.ceil(canvas.width * (defaultHeight / defaultWidth));
            pad = canvas.width < 500 ? 10 : 20;
            hexagonSideLength = (canvas.width - 2 * pad) / (10 * Math.sqrt(3));
            redraw();
        }

        function initialize() {
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();

            canvas.addEventListener('click', onCanvasClicked);
            canvas.addEventListener("contextmenu", e => {
                e.preventDefault();
                onCanvasClicked(e);
            });

            const evtSource = new EventSource("/hexz/sse/" + gameId());
            evtSource.onmessage = (event) => {
                handleServerEvent(JSON.parse(event.data));
            }
            evtSource.onerror = (err) => {
                // Do nothing for now, the Browser will try to reconnect.
            }
        }

        function onCanvasClicked(event) {
            if (event.button != 0 || event.altKey || event.metaKey || event.ctrlKey || event.shiftKey) {
                const e = event;
                console.log(`Click event: button=${e.button} altKey=${e.altKey} metaKey=${e.metaKey} ctrlKey=${e.ctrlKey} shiftKey=${e.shiftKey}`);
                return;
            }
            const c = document.getElementById("canvas");
            const ctx = canvas.getContext("2d");
            ctx.resetTransform();
            ctx.translate(pad, pad);
            let a = hexagonSideLength;
            let b = Math.sqrt(3) * a;
            let nRows = gstate.board.fields.length;
            let hex = hexagon(a);
            for (let i = 0; i < nRows; i++) {
                for (let j = 0; j < gstate.board.fields[i].length; j++) {
                    let xOff = (i % 2 == 0) ? 0 : b / 2;
                    let x = xOff + j * b + b / 2;
                    let y = i * a * 3 / 2 + a;
                    ctx.translate(x, y);
                    if (ctx.isPointInPath(hex, event.offsetX, event.offsetY)) {
                        clickedOnField(i, j);
                        break;
                    }
                    ctx.translate(-x, -y);
                }
            }
            ctx.resetTransform();
        }

        function clickedOnField(row, col) {
            sendMove(row, col);
        }

        function reset() {
            redraw();
        }

        var hexagonSideLength = 30;
        var pad = 20;

        const styles = {
            colors: {
                grid: '#cbcbcb',
                players: ['#255ab4', '#f8d748'],
            },
        };

        initialize();

    </script>
</body>

</html>